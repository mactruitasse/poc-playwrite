# values-prod.yaml

# --- Image n8n custom (pré-bakée avec n8n-nodes-playwright)
image:
  repository: n8n-playwright-local
  tag: "2.2.4-pw1.49.0-fix4"
  pullPolicy: IfNotPresent

# --- Service (port utilisé par l'Ingress : $.Values.service.port)
service:
  port: 5678

# --- Ingress (avec annotation Argo CD)
# IMPORTANT: ingress.hosts[].host ne doit JAMAIS contenir de port (pas de :5678)
ingress:
  enabled: true
  className: nginx
  annotations:
    argocd.argoproj.io/sync-wave: "10"
  hosts:
    - host: n8n.localhost
      paths:
        - path: /
          pathType: Prefix
  tls: []

# --- Base de données (queue mode => Postgres)
db:
  type: postgresdb

# --- PostgreSQL (subchart)
postgresql:
  enabled: true
  auth:
    database: n8n
    username: n8n
    password: n8n-local-password

# --- Redis (subchart)
redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: true
    password: redis-local-password

# --- Queue mode : workers + webhook processors
worker:
  mode: queue
  count: 1
  concurrency: 5
  readinessProbe:
    httpGet:
      path: /healthz/readiness
      port: http
    timeoutSeconds: 2
  extraEnvVars:
    N8N_COMMUNITY_PACKAGES_ENABLED: "true"

webhook:
  mode: queue
  count: 1
  # IMPORTANT: ce chart réutilise webhook.url pour construire un host d'Ingress.
  # Donc NE PAS mettre de port ici, sinon l'Ingress devient invalide.
  url: "http://n8n.localhost"
  readinessProbe:
    httpGet:
      path: /healthz/readiness
      port: http
    timeoutSeconds: 2
  extraEnvVars:
    N8N_COMMUNITY_PACKAGES_ENABLED: "true"

main:
  count: 1
  readinessProbe:
    httpGet:
      path: /healthz/readiness
      port: http
    # évite la probe trop tôt (observé : connection refused juste après le start)
    initialDelaySeconds: 20
    periodSeconds: 10
    timeoutSeconds: 2
    failureThreshold: 12
  extraEnvVars:
    N8N_COMMUNITY_PACKAGES_ENABLED: "true"

# --- IMPORTANT : on désactive l'installation de community nodes au runtime
# car n8n-nodes-playwright refuse npm (only-allow pnpm).
# Le package est déjà dans l'image Docker.
nodes:
  external:
    allowAll: false
    packages: []
    reinstallMissingPackages: false
